<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>mini-claw</title>
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --surface2: #21262d;
      --border: #30363d;
      --text: #e6edf3;
      --text2: #8b949e;
      --accent: #58a6ff;
      --green: #3fb950;
      --red: #f85149;
      --yellow: #d29922;
      --purple: #bc8cff;
      --radius: 8px;
      --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --mono: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      font-size: 14px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    header h1 {
      font-size: 16px;
      font-weight: 600;
      color: var(--accent);
    }

    header .status {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text2);
      font-size: 12px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--green);
    }

    .dot.offline {
      background: var(--red);
    }

    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 14px 16px 10px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text2);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .session-list {
      flex: 1;
      overflow-y: auto;
      padding: 4px 8px;
    }

    .session-item {
      padding: 8px 10px;
      border-radius: var(--radius);
      cursor: pointer;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .session-item:hover {
      background: var(--surface2);
    }

    .session-item.active {
      background: var(--surface2);
      border: 1px solid var(--border);
    }

    .session-item .avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: var(--bg);
      flex-shrink: 0;
    }

    .session-item .info {
      min-width: 0;
    }

    .session-item .name {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 13px;
    }

    .session-item .model {
      font-size: 11px;
      color: var(--text2);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sidebar-footer {
      padding: 8px;
      border-top: 1px solid var(--border);
    }

    .add-session-btn {
      width: 100%;
      padding: 8px;
      background: transparent;
      border: 1px dashed var(--border);
      color: var(--text2);
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 12px;
    }

    .add-session-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Center: Chat */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .chat-toolbar {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--surface);
      flex-shrink: 0;
    }

    .chat-toolbar .title {
      font-weight: 600;
      font-size: 15px;
    }

    .chat-toolbar .spacer {
      flex: 1;
    }

    .btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 5px 12px;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 12px;
      font-family: var(--font);
    }

    .btn:hover {
      background: var(--border);
    }

    .btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg);
    }

    .btn.primary:hover {
      opacity: 0.85;
    }

    .btn.danger {
      border-color: var(--red);
      color: var(--red);
    }

    .btn.danger:hover {
      background: rgba(248, 81, 73, 0.1);
    }

    .btn.icon {
      padding: 5px 8px;
      font-size: 14px;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      display: flex;
      gap: 10px;
      max-width: 800px;
    }

    .message.assistant {
      align-self: flex-start;
    }

    .message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message .bubble {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 14px;
      max-width: 680px;
      line-height: 1.6;
    }

    .message.user .bubble {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg);
    }

    .message .role {
      font-size: 11px;
      color: var(--text2);
      margin-bottom: 4px;
      font-weight: 600;
    }

    .message pre {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 10px;
      overflow-x: auto;
      font-family: var(--mono);
      font-size: 12px;
      margin: 6px 0;
    }

    .message code {
      font-family: var(--mono);
      font-size: 12px;
      background: var(--bg);
      padding: 1px 4px;
      border-radius: 3px;
    }

    .tool-event {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 12px;
      font-size: 12px;
      color: var(--text2);
      font-family: var(--mono);
      align-self: center;
      max-width: 600px;
    }

    .tool-event .tool-name {
      color: var(--yellow);
      font-weight: 600;
    }

    .tool-event .tool-ok {
      color: var(--green);
    }

    .tool-event .tool-err {
      color: var(--red);
    }

    .input-area {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
    }

    .input-row {
      display: flex;
      gap: 8px;
    }

    textarea {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: var(--radius);
      padding: 10px 14px;
      font-family: var(--font);
      font-size: 14px;
      resize: none;
      outline: none;
      min-height: 44px;
      max-height: 200px;
    }

    textarea:focus {
      border-color: var(--accent);
    }

    textarea::placeholder {
      color: var(--text2);
    }

    .send-btn {
      background: var(--accent);
      border: none;
      color: var(--bg);
      width: 44px;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 18px;
      flex-shrink: 0;
    }

    .send-btn:hover {
      opacity: 0.85;
    }

    .send-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }

    /* Right panel */
    .right-panel {
      width: 280px;
      background: var(--surface);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      font-size: 12px;
      color: var(--text2);
      border-bottom: 2px solid transparent;
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .tab-content {
      flex: 1;
      overflow-y: auto;
      display: none;
      padding: 12px;
    }

    .tab-content.active {
      display: block;
    }

    .file-section {
      margin-bottom: 16px;
    }

    .file-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text2);
      text-transform: uppercase;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .file-editor {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 4px;
      padding: 8px;
      font-family: var(--mono);
      font-size: 11px;
      resize: vertical;
      min-height: 80px;
      outline: none;
    }

    .file-editor:focus {
      border-color: var(--accent);
    }

    .save-btn {
      font-size: 10px;
      padding: 2px 8px;
    }

    .memory-entry {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .memory-meta {
      font-size: 10px;
      color: var(--text2);
      margin-top: 4px;
    }

    .system-info {
      font-size: 12px;
    }

    .system-info .row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
    }

    .system-info .val {
      color: var(--accent);
      font-family: var(--mono);
    }

    .empty {
      color: var(--text2);
      font-size: 12px;
      text-align: center;
      padding: 20px;
    }

    .typing {
      display: flex;
      gap: 4px;
      align-items: center;
      padding: 4px 0;
    }

    .typing span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text2);
      animation: bounce 1.2s infinite;
    }

    .typing span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes bounce {

      0%,
      60%,
      100% {
        transform: translateY(0)
      }

      30% {
        transform: translateY(-6px)
      }
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-header h2 {
      font-size: 16px;
      font-weight: 600;
    }

    .modal-header .close {
      margin-left: auto;
      background: transparent;
      border: none;
      color: var(--text2);
      font-size: 20px;
      cursor: pointer;
    }

    .modal-header .close:hover {
      color: var(--text);
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    /* Settings */
    .settings-section {
      margin-bottom: 24px;
    }

    .settings-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .settings-title .add-btn {
      font-size: 11px;
      margin-left: auto;
    }

    .env-list,
    .session-list-config {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .env-item,
    .session-item-config {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .env-item .env-info,
    .session-item-config .session-info {
      flex: 1;
      min-width: 0;
    }

    .env-item .env-name,
    .session-item-config .session-name {
      font-weight: 500;
      font-size: 13px;
    }

    .env-item .env-detail,
    .session-item-config .session-detail {
      font-size: 11px;
      color: var(--text2);
      margin-top: 2px;
    }

    .env-item .env-actions,
    .session-item-config .session-actions {
      display: flex;
      gap: 4px;
    }

    /* Form */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text2);
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 4px;
      padding: 8px 12px;
      font-family: var(--font);
      font-size: 13px;
      outline: none;
    }

    .form-input:focus {
      border-color: var(--accent);
    }

    .form-input.mono {
      font-family: var(--mono);
      font-size: 12px;
    }

    .form-row {
      display: flex;
      gap: 12px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .form-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-checkbox input {
      width: 16px;
      height: 16px;
    }

    .form-hint {
      font-size: 11px;
      color: var(--text2);
      margin-top: 4px;
    }

    /* Tabs in modal */
    .modal-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
    }

    .modal-tab {
      padding: 8px 16px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      color: var(--text2);
    }

    .modal-tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg);
    }

    /* Tag input */
    .tag-input {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 4px;
    }

    .tag {
      background: var(--border);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .tag .remove {
      cursor: pointer;
      opacity: 0.6;
    }

    .tag .remove:hover {
      opacity: 1;
    }

    .tag-input input {
      flex: 1;
      min-width: 100px;
      border: none;
      background: transparent;
      color: var(--text);
      font-size: 12px;
      outline: none;
      padding: 4px;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    /* Autocomplete Popup */
    .autocomplete-popup {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 16px;
      width: clamp(250px, 50%, 400px);
      max-height: 250px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      overflow-y: auto;
      z-index: 100;
      display: none;
      flex-direction: column;
    }

    .autocomplete-popup.active {
      display: flex;
    }

    .autocomplete-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
      background: var(--accent);
      color: var(--bg);
    }

    .autocomplete-item.selected .skill-desc {
      color: rgba(0, 0, 0, 0.7);
    }

    .skill-name {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 2px;
    }

    .skill-desc {
      font-size: 11px;
      color: var(--text2);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>

<body>
  <header>
    <h1>üêæ mini-claw</h1>
    <div class="status">
      <button class="btn icon" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
      <div class="dot" id="ws-dot"></div>
      <span id="ws-status">Connecting...</span>
    </div>
  </header>
  <div class="main">
    <div class="sidebar">
      <div class="sidebar-header">Sessions</div>
      <div class="session-list" id="session-list"></div>
      <div class="sidebar-footer">
        <button class="add-session-btn" onclick="openNewSessionModal()">+ New Session</button>
      </div>
    </div>
    <div class="chat-area">
      <div class="chat-toolbar">
        <span class="title" id="chat-title">Select a session</span>
        <div class="spacer"></div>
        <button class="btn" onclick="openSessionSettings()" id="session-settings-btn"
          style="display:none">Settings</button>
        <button class="btn danger" onclick="clearHistory()" style="display:none" id="clear-btn">Clear</button>
      </div>
      <div class="messages" id="messages">
        <div class="empty">Select a session to start chatting</div>
      </div>
      <div class="input-area" style="position: relative;">
        <div class="autocomplete-popup" id="autocomplete-popup"></div>
        <div class="input-row">
          <textarea id="input" placeholder="Message..." rows="1" onkeydown="handleInputKey(event)"
            oninput="handleInputValue(this)"></textarea>
          <button class="send-btn" id="send-btn" onclick="sendMessage()" disabled>‚û§</button>
        </div>
      </div>
    </div>
    <div class="right-panel">
      <div class="tabs">
        <div class="tab active" onclick="switchTab('files')">Files</div>
        <div class="tab" onclick="switchTab('memory')">Memory</div>
        <div class="tab" onclick="switchTab('system')">System</div>
      </div>
      <div class="tab-content active" id="tab-files">
        <div id="file-editors"></div>
      </div>
      <div class="tab-content" id="tab-memory">
        <div id="memory-list">
          <div class="empty">Select a session</div>
        </div>
      </div>
      <div class="tab-content" id="tab-system">
        <div id="system-info" class="system-info"></div>
      </div>
    </div>
  </div>





  <!-- Settings Modal (Global) -->
  <div class="modal-overlay" id="settings-modal">
    <div class="modal">
      <div class="modal-header">
        <h2>‚öôÔ∏è Settings</h2>
        <button class="close" onclick="closeSettings()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-tabs">
          <div class="modal-tab active" onclick="switchSettingsTab('search')">Search Engine</div>
          <div class="modal-tab" onclick="switchSettingsTab('skills')">Skills</div>
        </div>

        <!-- Search Engine Tab -->
        <div id="settings-search" class="settings-section" style="margin-top:20px;">
          <div class="form-group">
            <label class="form-label">Search Provider</label>
            <select class="form-input" id="search-provider" onchange="toggleSearchProviderFields()">
              <option value="brave">Brave Search API</option>
              <option value="serper">Serper (Google Search)</option>
              <option value="vertex">Google Vertex AI Search</option>
            </select>
          </div>

          <div id="search-fields-brave" class="search-provider-fields">
            <div class="form-group">
              <label class="form-label">Brave API Key</label>
              <input type="password" class="form-input mono" id="search-brave-apikey" placeholder="BSA...">
            </div>
          </div>

          <div id="search-fields-serper" class="search-provider-fields" style="display:none;">
            <div class="form-group">
              <label class="form-label">Serper API Key</label>
              <input type="password" class="form-input mono" id="search-serper-apikey" placeholder="...">
            </div>
          </div>

          <div id="search-fields-vertex" class="search-provider-fields" style="display:none;">
            <div class="form-group">
              <label class="form-label">Google Cloud Project ID</label>
              <input type="text" class="form-input mono" id="search-vertex-project-id" placeholder="my-gcp-project">
            </div>
            <div class="form-group">
              <label class="form-label">Datastore Location</label>
              <input type="text" class="form-input mono" id="search-vertex-location" placeholder="global">
            </div>
            <div class="form-group">
              <label class="form-label">Datastore ID</label>
              <input type="text" class="form-input mono" id="search-vertex-datastore-id" placeholder="...">
            </div>
            <div class="form-hint" style="margin-top:10px;">Note: Vertex AI authentication requires Google Application
              Default Credentials (ADC).</div>
          </div>
        </div>

        <!-- Skills Tab -->
        <div id="settings-skills" class="settings-section" style="display:none; margin-top:20px;">
          <div class="settings-title">
            Installed Skills
            <button class="btn add-btn" onclick="refreshGlobalSkills()">Refresh</button>
          </div>
          <div id="global-skills-list" class="env-list">
            <div class="empty">Loading skills...</div>
          </div>
          <div class="form-hint" style="margin-top:10px;">
            Skills enhance the AI's capabilities. Install them using <code>npx skills add</code>.
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeSettings()">Cancel</button>
        <button class="btn primary" onclick="saveGlobalSettings()">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- Session Settings Modal -->
  <div class="modal-overlay" id="session-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="session-modal-title">Session Settings</h2>
        <button class="close" onclick="closeSessionModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-tabs">
          <div class="modal-tab active" onclick="switchSessionSettingsTab('general')">General</div>
          <div class="modal-tab" onclick="switchSessionSettingsTab('discord')">Discord</div>
        </div>

        <!-- General Tab -->
        <div id="session-settings-general">
          <div class="form-group">
            <label class="form-label">Session Name</label>
            <input type="text" class="form-input" id="session-name">
          </div>
          <div class="form-group">
            <label class="form-label">Description</label>
            <input type="text" class="form-input" id="session-description" placeholder="Optional description">
          </div>
          <div class="form-group">
            <label class="form-label">API Endpoint</label>
            <input type="text" class="form-input mono" id="session-provider-endpoint"
              placeholder="https://api.openai.com/v1">
          </div>
          <div class="form-group">
            <label class="form-label">API Key</label>
            <input type="password" class="form-input mono" id="session-provider-apikey" placeholder="sk-...">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Model</label>
              <input type="text" class="form-input mono" id="session-provider-model" placeholder="gpt-4o">
            </div>
            <div class="form-group">
              <label class="form-label">Embedding Model</label>
              <input type="text" class="form-input mono" id="session-provider-embedding-model"
                placeholder="text-embedding-3-small">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Context Window</label>
            <input type="number" class="form-input" id="session-provider-context-window" placeholder="128000">
          </div>
          <div class="form-group">
            <label class="form-label">Workspace Path</label>
            <input type="text" class="form-input mono" id="session-workspace">
          </div>
          <div class="form-group">
            <label class="form-checkbox">
              <input type="checkbox" id="session-restrict-workspace">
              <span>Restrict to workspace</span>
            </label>
          </div>
          <div class="form-group">
            <label class="form-checkbox">
              <input type="checkbox" id="session-allow-self-modify">
              <span>Allow self-modification</span>
            </label>
          </div>
          <div class="form-group">
            <label class="form-label">Tools</label>
            <div style="display:flex; gap: 16px;">
              <label class="form-checkbox"><input type="checkbox" id="session-tool-exec"> exec</label>
              <label class="form-checkbox"><input type="checkbox" id="session-tool-web"> web</label>
              <label class="form-checkbox"><input type="checkbox" id="session-tool-memory"> memory</label>
            </div>
          </div>
        </div>

        <!-- Discord Tab -->
        <div id="session-settings-discord" style="display:none">
          <div class="form-group">
            <label class="form-checkbox">
              <input type="checkbox" id="session-discord-enabled">
              <span>Enable Discord integration for this session</span>
            </label>
          </div>
          <div class="form-group">
            <label class="form-label">Bot Token</label>
            <input type="password" class="form-input mono" id="session-discord-token"
              placeholder="Enter Discord bot token">
            <div class="form-hint">Requires mini-claw restart to apply new tokens</div>
          </div>
          <div class="form-group">
            <label class="form-label">Channel IDs</label>
            <div class="tag-input" id="channels-input">
              <input type="text" placeholder="Add channel ID and press Enter">
            </div>
            <div class="form-hint">Discord channel IDs this session should respond to</div>
          </div>
          <div class="form-group">
            <label class="form-label">Guild IDs</label>
            <div class="tag-input" id="guilds-input">
              <input type="text" placeholder="Add guild ID and press Enter">
            </div>
            <div class="form-hint">Discord server IDs this session should respond to</div>
          </div>
          <div class="form-group">
            <label class="form-label">Allowed User IDs</label>
            <div class="tag-input" id="allow-from-input">
              <input type="text" placeholder="Add user ID and press Enter">
            </div>
            <div class="form-hint">Leave empty to allow all users</div>
          </div>
          <div class="form-group">
            <label class="form-label">Command Prefix</label>
            <input type="text" class="form-input mono" id="session-discord-prefix" placeholder="!"
              style="max-width:100px">
            <div class="form-hint">Optional prefix for commands</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn danger" onclick="deleteCurrentSession()" id="delete-session-btn">Delete Session</button>
        <button class="btn" onclick="closeSessionModal()">Cancel</button>
        <button class="btn primary" onclick="saveSessionSettings()">Save</button>
      </div>
    </div>
  </div>

  <!-- New Session Modal -->
  <div class="modal-overlay" id="new-session-modal">
    <div class="modal">
      <div class="modal-header">
        <h2>+ New Session</h2>
        <button class="close" onclick="closeNewSessionModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Session ID</label>
          <input type="text" class="form-input mono" id="new-session-id" placeholder="my-agent">
          <div class="form-hint">Unique identifier (alphanumeric, dashes allowed)</div>
        </div>
        <div class="form-group">
          <label class="form-label">Name</label>
          <input type="text" class="form-input" id="new-session-name" placeholder="My Agent">
        </div>
        <div class="form-group">
          <label class="form-label">API Endpoint</label>
          <input type="text" class="form-input mono" id="new-session-provider-endpoint"
            value="https://api.openai.com/v1">
        </div>
        <div class="form-group">
          <label class="form-label">API Key</label>
          <input type="password" class="form-input mono" id="new-session-provider-apikey" placeholder="sk-...">
        </div>
        <div class="form-group">
          <label class="form-label">Model</label>
          <input type="text" class="form-input mono" id="new-session-provider-model" value="gpt-4o">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeNewSessionModal()">Cancel</button>
        <button class="btn primary" onclick="createNewSession()">Create</button>
      </div>
    </div>
  </div>

  <script>
    let currentSession = null;
    let sessions = [];
    let ws = null;
    let isThinking = false;
    let availableSkills = [];
    let filteredSkills = [];
    let selectedSkillIndex = -1;

    async function loadSkillsList() {
      if (!currentSession) return;
      try {
        const res = await fetch(`/api/sessions/${currentSession}/skills`);
        availableSkills = await res.json();
      } catch (e) {
        console.error('Failed to load skills list');
        availableSkills = [];
      }
    }

    function renderAutocomplete() {
      const popup = document.getElementById('autocomplete-popup');
      if (filteredSkills.length === 0) {
        popup.classList.remove('active');
        return;
      }

      popup.innerHTML = '';
      filteredSkills.forEach((skill, index) => {
        const el = document.createElement('div');
        el.className = 'autocomplete-item' + (index === selectedSkillIndex ? ' selected' : '');
        el.innerHTML = `<div class="skill-name">/${skill.name}</div><div class="skill-desc">${escapeHtml(skill.description)}</div>`;

        el.onmousedown = (e) => {
          e.preventDefault(); // Prevent input blur
          applySkill(skill);
        };

        // Scroll into view if selected
        if (index === selectedSkillIndex) {
          // simple scroll logic
          setTimeout(() => {
            el.scrollIntoView({ block: 'nearest' });
          }, 0);
        }

        popup.appendChild(el);
      });
      popup.classList.add('active');
    }

    function hideAutocomplete() {
      document.getElementById('autocomplete-popup').classList.remove('active');
      filteredSkills = [];
      selectedSkillIndex = -1;
    }

    function applySkill(skill) {
      const input = document.getElementById('input');
      // Replace the matched slash command prefix with the selected skill
      const parts = input.value.split(/\s+/);
      parts[parts.length - 1] = `/${skill.name} `;
      input.value = parts.join(' ');
      hideAutocomplete();
      input.focus();
    }

    function handleInputKey(e) {
      const popup = document.getElementById('autocomplete-popup');
      const isAutocompleteVisible = popup.classList.contains('active');

      if (isAutocompleteVisible) {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedSkillIndex = Math.min(selectedSkillIndex + 1, filteredSkills.length - 1);
          renderAutocomplete();
          return;
        }
        if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedSkillIndex = Math.max(selectedSkillIndex - 1, 0);
          renderAutocomplete();
          return;
        }
        if (e.key === 'Enter' || e.key === 'Tab') {
          e.preventDefault();
          if (filteredSkills[selectedSkillIndex]) {
            applySkill(filteredSkills[selectedSkillIndex]);
          }
          return;
        }
        if (e.key === 'Escape') {
          e.preventDefault();
          hideAutocomplete();
          return;
        }
      }

      // Default behavior
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    function handleInputValue(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 200) + 'px';

      const val = el.value;

      // Basic match for slash commands at the start of current cursor word
      const lastWord = val.split(/\s+/).pop();
      if (lastWord.startsWith('/')) {
        const query = lastWord.slice(1).toLowerCase();
        filteredSkills = availableSkills.filter(s => s.name.toLowerCase().includes(query));
        selectedSkillIndex = filteredSkills.length > 0 ? 0 : -1;
        renderAutocomplete();
      } else {
        hideAutocomplete();
      }
    }

    function connectWS() {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${proto}//${location.host}`);
      ws.onopen = () => { setWsStatus(true); };
      ws.onclose = () => { setWsStatus(false); setTimeout(connectWS, 3000); };
      ws.onerror = () => setWsStatus(false);
      ws.onmessage = (e) => {
        const event = JSON.parse(e.data);
        handleEvent(event);
      };
    }

    function setWsStatus(connected) {
      document.getElementById('ws-dot').className = connected ? 'dot' : 'dot offline';
      document.getElementById('ws-status').textContent = connected ? 'Connected' : 'Disconnected';
    }

    function handleEvent(event) {
      if (event.sessionId !== currentSession) return;
      if (event.type === 'tool_call') {
        removeTyping();
        const names = event.data.tools.map(t => t.name).join(', ');
        appendToolEvent(`‚öô ${names}`, null);
      } else if (event.type === 'tool_result') {
        const ok = event.data.success;
        appendToolEvent(`${ok ? '‚úì' : '‚úó'} ${event.data.tool}: ${event.data.output.slice(0, 100)}`, ok);
      } else if (event.type === 'message' && event.data.role === 'assistant') {
        removeTyping();
        appendMessage('assistant', event.data.content);
        isThinking = false;
        document.getElementById('send-btn').disabled = false;
        document.getElementById('input').disabled = false;
      } else if (event.type === 'heartbeat') {
        appendToolEvent(`üíì Heartbeat: ${event.data.response?.slice(0, 100)}`, true);
      }
    }

    async function loadSessions() {
      const res = await fetch('/api/sessions');
      sessions = await res.json();
      const list = document.getElementById('session-list');
      list.innerHTML = '';
      sessions.forEach(s => {
        const el = document.createElement('div');
        el.className = 'session-item' + (s.id === currentSession ? ' active' : '');
        el.innerHTML = `<div class="avatar">${s.name.charAt(0).toUpperCase()}</div><div class="info"><div class="name">${s.name}</div><div class="model">${s.model}</div></div>`;
        el.onclick = () => selectSession(s.id);
        list.appendChild(el);
      });
    }

    async function selectSession(id) {
      currentSession = id;
      loadSessions();
      const session = sessions.find(s => s.id === id);
      document.getElementById('chat-title').textContent = session?.name ?? id;
      document.getElementById('clear-btn').style.display = '';
      document.getElementById('session-settings-btn').style.display = '';
      document.getElementById('send-btn').disabled = false;
      document.getElementById('input').disabled = false;
      await loadHistory();
      await loadFiles();
      await loadMemory();
      await loadSkillsList(); // load skills for autocompletion
    }

    async function loadHistory() {
      const res = await fetch(`/api/sessions/${currentSession}/history`);
      const history = await res.json();
      const container = document.getElementById('messages');
      container.innerHTML = '';
      history.forEach(m => {
        if (m.role === 'user' || m.role === 'assistant') {
          appendMessage(m.role, m.content, false);
        }
      });
      container.scrollTop = container.scrollHeight;
    }

    function appendMessage(role, content, scroll = true) {
      const container = document.getElementById('messages');
      const emptyEl = container.querySelector('.empty');
      if (emptyEl) emptyEl.remove();
      const div = document.createElement('div');
      div.className = `message ${role}`;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      if (role === 'assistant') {
        const roleLabel = document.createElement('div');
        roleLabel.className = 'role';
        roleLabel.textContent = 'AI';
        bubble.appendChild(roleLabel);
      }
      const text = document.createElement('div');
      text.innerHTML = formatMarkdown(content || '');
      bubble.appendChild(text);
      div.appendChild(bubble);
      container.appendChild(div);
      if (scroll) container.scrollTop = container.scrollHeight;
    }

    function appendToolEvent(text, success) {
      const container = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = 'tool-event';
      div.innerHTML = `<span class="${success === null ? '' : success ? 'tool-ok' : 'tool-err'}">${escapeHtml(text)}</span>`;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function showTyping() {
      const container = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = 'message assistant';
      div.id = 'typing-indicator';
      div.innerHTML = '<div class="bubble"><div class="typing"><span></span><span></span><span></span></div></div>';
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function removeTyping() {
      document.getElementById('typing-indicator')?.remove();
    }

    async function sendMessage() {
      if (!currentSession || isThinking) return;
      const input = document.getElementById('input');
      const msg = input.value.trim();
      if (!msg) return;
      input.value = '';
      handleInputValue(input);
      appendMessage('user', msg);
      isThinking = true;
      document.getElementById('send-btn').disabled = true;
      input.disabled = true;
      showTyping();
      try {
        await fetch(`/api/sessions/${currentSession}/message`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msg }),
        });
      } catch (e) {
        removeTyping();
        appendMessage('assistant', 'Error: ' + e.message);
        isThinking = false;
        document.getElementById('send-btn').disabled = false;
        input.disabled = false;
      }
    }

    async function clearHistory() {
      if (!currentSession || !confirm('Clear conversation history?')) return;
      await fetch(`/api/sessions/${currentSession}/history`, { method: 'DELETE' });
      document.getElementById('messages').innerHTML = '<div class="empty">History cleared</div>';
    }

    const FILES = ['IDENTITY.md', 'USER.md', 'MEMORY.md', 'HEARTBEAT.md'];
    async function loadFiles() {
      const container = document.getElementById('file-editors');
      container.innerHTML = '';
      for (const f of FILES) {
        const res = await fetch(`/api/sessions/${currentSession}/files/${f}`);
        const { content } = await res.json();
        const section = document.createElement('div');
        section.className = 'file-section';
        section.innerHTML = `
      <div class="file-label">${f} <button class="btn save-btn" onclick="saveFile('${f}', this)">Save</button></div>
      <textarea class="file-editor" id="editor-${f}" rows="5">${escapeHtml(content)}</textarea>
    `;
        container.appendChild(section);
      }
    }

    async function saveFile(filename, btn) {
      const content = document.getElementById(`editor-${filename}`).value;
      await fetch(`/api/sessions/${currentSession}/files/${filename}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content }),
      });
      btn.textContent = 'Saved!';
      setTimeout(() => btn.textContent = 'Save', 1500);
    }

    async function loadMemory() {
      const res = await fetch(`/api/sessions/${currentSession}/memory`);
      const entries = await res.json();
      const container = document.getElementById('memory-list');
      if (!entries.length) { container.innerHTML = '<div class="empty">No long-term memories yet</div>'; return; }
      container.innerHTML = entries.slice(0, 50).map(e => `
    <div class="memory-entry">
      <div>${escapeHtml(e.text.slice(0, 200))}</div>
      <div class="memory-meta">${e.metadata.timestamp?.slice(0, 10) ?? ''} ${e.metadata.category ? '¬∑ ' + e.metadata.category : ''}</div>
    </div>
  `).join('');
    }

    function switchTab(name) {
      document.querySelectorAll('.tab').forEach((t, i) => t.className = 'tab' + (['files', 'memory', 'system'][i] === name ? ' active' : ''));
      document.querySelectorAll('.tab-content').forEach(c => c.className = 'tab-content');
      document.getElementById(`tab-${name}`).className = 'tab-content active';
      if (name === 'system') loadSystemInfo();
    }

    async function loadSystemInfo() {
      const res = await fetch('/api/system');
      const info = await res.json();
      const container = document.getElementById('system-info');
      const mb = v => (v / 1024 / 1024).toFixed(1) + ' MB';
      container.innerHTML = `
    <div class="row"><span>Uptime</span><span class="val">${Math.floor(info.uptime)}s</span></div>
    <div class="row"><span>Sessions</span><span class="val">${info.sessions}</span></div>
    <div class="row"><span>Node</span><span class="val">${info.nodeVersion}</span></div>
    <div class="row"><span>Heap Used</span><span class="val">${mb(info.memory.heapUsed)}</span></div>
    <div class="row"><span>RSS</span><span class="val">${mb(info.memory.rss)}</span></div>
    <div class="row"><span>Version</span><span class="val">${info.version}</span></div>
  `;
    }

    // ==================== Settings ====================

    async function openSettings() {
      try {
        const res = await fetch('/api/search');
        if (res.ok) {
          const searchConfig = await res.json();
          document.getElementById('search-provider').value = searchConfig.provider || 'brave';
          document.getElementById('search-brave-apikey').value = searchConfig.braveApiKey || '';
          document.getElementById('search-serper-apikey').value = searchConfig.serperApiKey || '';
          document.getElementById('search-vertex-project-id').value = searchConfig.vertexProjectId || '';
          document.getElementById('search-vertex-location').value = searchConfig.vertexLocation || 'global';
          document.getElementById('search-vertex-datastore-id').value = searchConfig.vertexDataStoreId || '';
          toggleSearchProviderFields();
        }
      } catch (e) {
        console.error('Failed to load search config', e);
      }
      document.getElementById('settings-modal').classList.add('active');
    }

    function closeSettings() {
      document.getElementById('settings-modal').classList.remove('active');
    }

    function switchSettingsTab(tab) {
      const tabs = document.querySelectorAll('#settings-modal .modal-tabs .modal-tab');
      tabs.forEach((t, i) => t.className = 'modal-tab' + (['search', 'skills'][i] === tab ? ' active' : ''));
      document.getElementById('settings-search').style.display = tab === 'search' ? 'block' : 'none';
      document.getElementById('settings-skills').style.display = tab === 'skills' ? 'block' : 'none';

      if (tab === 'skills') {
        refreshGlobalSkills();
      }
    }

    async function refreshGlobalSkills() {
      const list = document.getElementById('global-skills-list');
      list.innerHTML = '<div class="empty">Loading skills...</div>';
      try {
        // Fetch skills from the current session or a default mock session just to use the loading logic.
        // Wait, skills are tied to session workspace + cwd. 
        // If there's no session, we can't fetch them specifically, but we can hit the server API directly, wait, there's no global skills API.
        // Let's fallback to currentSession if available or show a message.
        if (!currentSession) {
          list.innerHTML = '<div class="empty">Please select a session first to view available skills.</div>';
          return;
        }
        const res = await fetch(`/api/sessions/${currentSession}/skills`);
        const skills = await res.json();
        if (!skills || skills.length === 0) {
          list.innerHTML = '<div class="empty">No skills found.</div>';
          return;
        }
        list.innerHTML = skills.map(skill => `
          <div class="env-item">
            <div class="env-info">
              <div class="env-name">/${escapeHtml(skill.name)}</div>
              <div class="env-detail">${escapeHtml(skill.description)}</div>
            </div>
          </div>
        `).join('');
      } catch (e) {
        list.innerHTML = '<div class="empty" style="color:var(--red)">Error loading skills.</div>';
      }
    }

    function toggleSearchProviderFields() {
      const provider = document.getElementById('search-provider').value;
      document.getElementById('search-fields-brave').style.display = provider === 'brave' ? 'block' : 'none';
      document.getElementById('search-fields-serper').style.display = provider === 'serper' ? 'block' : 'none';
      document.getElementById('search-fields-vertex').style.display = provider === 'vertex' ? 'block' : 'none';
    }

    async function saveGlobalSettings() {
      const data = {
        provider: document.getElementById('search-provider').value,
        braveApiKey: document.getElementById('search-brave-apikey').value,
        serperApiKey: document.getElementById('search-serper-apikey').value,
        vertexProjectId: document.getElementById('search-vertex-project-id').value,
        vertexLocation: document.getElementById('search-vertex-location').value,
        vertexDataStoreId: document.getElementById('search-vertex-datastore-id').value,
      };

      const res = await fetch('/api/search', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (res.ok) {
        closeSettings();
      } else {
        const err = await res.json();
        alert('Error saving settings: ' + err.error);
      }
    }





    // ==================== Session Settings ====================

    async function openSessionSettings() {
      if (!currentSession) return;

      const res = await fetch(`/api/sessions/${currentSession}/config`);
      const config = await res.json();

      document.getElementById('session-name').value = config.name || '';
      document.getElementById('session-description').value = config.description || '';

      const p = config.provider || {};
      document.getElementById('session-provider-endpoint').value = p.endpoint || '';
      document.getElementById('session-provider-apikey').value = p.apiKey || '';
      document.getElementById('session-provider-model').value = p.model || '';
      document.getElementById('session-provider-embedding-model').value = p.embeddingModel || '';
      document.getElementById('session-provider-context-window').value = p.contextWindow || '';

      document.getElementById('session-workspace').value = config.workspace || '';
      document.getElementById('session-restrict-workspace').checked = config.restrictToWorkspace ?? true;
      document.getElementById('session-allow-self-modify').checked = config.allowSelfModify ?? false;
      document.getElementById('session-tool-exec').checked = config.tools?.exec ?? true;
      document.getElementById('session-tool-web').checked = config.tools?.web ?? true;
      document.getElementById('session-tool-memory').checked = config.tools?.memory ?? true;

      // Discord settings
      const discord = config.discord || {};
      document.getElementById('session-discord-enabled').checked = discord.enabled ?? false;
      document.getElementById('session-discord-token').value = discord.token || '';
      document.getElementById('session-discord-prefix').value = discord.prefix || '';

      // Set up tag inputs
      setupTagInput('channels-input', discord.channels || []);
      setupTagInput('guilds-input', discord.guilds || []);
      setupTagInput('allow-from-input', discord.allowFrom || []);

      document.getElementById('session-modal').classList.add('active');
    }

    function closeSessionModal() {
      document.getElementById('session-modal').classList.remove('active');
    }

    function switchSessionSettingsTab(tab) {
      const tabs = document.querySelectorAll('#session-modal .modal-tabs .modal-tab');
      tabs.forEach((t, i) => t.className = 'modal-tab' + (['general', 'discord'][i] === tab ? ' active' : ''));
      document.getElementById('session-settings-general').style.display = tab === 'general' ? 'block' : 'none';
      document.getElementById('session-settings-discord').style.display = tab === 'discord' ? 'block' : 'none';
    }

    async function saveSessionSettings() {
      const data = {
        name: document.getElementById('session-name').value,
        description: document.getElementById('session-description').value,
        provider: {
          endpoint: document.getElementById('session-provider-endpoint').value,
          apiKey: document.getElementById('session-provider-apikey').value,
          model: document.getElementById('session-provider-model').value,
          embeddingModel: document.getElementById('session-provider-embedding-model').value,
          contextWindow: parseInt(document.getElementById('session-provider-context-window').value) || undefined
        },
        workspace: document.getElementById('session-workspace').value,
        restrictToWorkspace: document.getElementById('session-restrict-workspace').checked,
        allowSelfModify: document.getElementById('session-allow-self-modify').checked,
        tools: {
          exec: document.getElementById('session-tool-exec').checked,
          web: document.getElementById('session-tool-web').checked,
          memory: document.getElementById('session-tool-memory').checked,
        },
        discord: {
          enabled: document.getElementById('session-discord-enabled').checked,
          token: document.getElementById('session-discord-token').value || undefined,
          channels: getTagInputValues('channels-input'),
          guilds: getTagInputValues('guilds-input'),
          allowFrom: getTagInputValues('allow-from-input'),
          prefix: document.getElementById('session-discord-prefix').value || undefined,
        },
      };

      const res = await fetch(`/api/sessions/${currentSession}/config`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (res.ok) {
        closeSessionModal();
        await loadSessions();
      } else {
        const err = await res.json();
        alert(err.error);
      }
    }

    async function deleteCurrentSession() {
      if (!confirm('Delete this session? This cannot be undone.')) return;

      const res = await fetch(`/api/sessions/${currentSession}`, { method: 'DELETE' });
      if (res.ok) {
        closeSessionModal();
        currentSession = null;
        document.getElementById('chat-title').textContent = 'Select a session';
        document.getElementById('clear-btn').style.display = 'none';
        document.getElementById('session-settings-btn').style.display = 'none';
        document.getElementById('messages').innerHTML = '<div class="empty">Select a session to start chatting</div>';
        await loadSessions();
      } else {
        const err = await res.json();
        alert(err.error);
      }
    }

    // ==================== New Session ====================

    async function openNewSessionModal() {
      document.getElementById('new-session-id').value = '';
      document.getElementById('new-session-name').value = '';
      document.getElementById('new-session-modal').classList.add('active');
    }

    function closeNewSessionModal() {
      document.getElementById('new-session-modal').classList.remove('active');
    }

    async function createNewSession() {
      const id = document.getElementById('new-session-id').value.trim();
      const name = document.getElementById('new-session-name').value.trim();
      const provider = {
        endpoint: document.getElementById('new-session-provider-endpoint').value,
        apiKey: document.getElementById('new-session-provider-apikey').value,
        model: document.getElementById('new-session-provider-model').value
      };

      if (!id) return alert('Session ID is required');
      if (!/^[a-zA-Z0-9_-]+$/.test(id)) return alert('Session ID must be alphanumeric (dashes and underscores allowed)');

      const res = await fetch('/api/sessions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, name: name || id, provider }),
      });

      if (res.ok) {
        closeNewSessionModal();
        await loadSessions();
        selectSession(id);
      } else {
        const err = await res.json();
        alert(err.error);
      }
    }

    // ==================== Tag Input ====================

    function setupTagInput(containerId, initialTags) {
      const container = document.getElementById(containerId);
      container.innerHTML = '<input type="text" placeholder="Add ID and press Enter">';

      initialTags.forEach(tag => addTag(containerId, tag));

      const input = container.querySelector('input');
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && input.value.trim()) {
          e.preventDefault();
          addTag(containerId, input.value.trim());
          input.value = '';
        }
      });
    }

    function addTag(containerId, value) {
      const container = document.getElementById(containerId);
      const input = container.querySelector('input');

      const tag = document.createElement('span');
      tag.className = 'tag';
      tag.innerHTML = `${escapeHtml(value)}<span class="remove" onclick="removeTag('${containerId}', this.parentElement)">√ó</span>`;
      container.insertBefore(tag, input);
    }

    function removeTag(containerId, tagEl) {
      tagEl.remove();
    }

    function getTagInputValues(containerId) {
      const container = document.getElementById(containerId);
      return Array.from(container.querySelectorAll('.tag')).map(t => t.textContent.replace('√ó', '').trim());
    }

    // ==================== Utils ====================

    function formatMarkdown(text) {
      return text
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');
    }
    function escapeHtml(text) {
      return String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    connectWS();
    loadSessions();
    setInterval(() => { if (document.getElementById('tab-system').className.includes('active')) loadSystemInfo(); }, 5000);
  </script>
</body>

</html>