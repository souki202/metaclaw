<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>mini-claw</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0d1117; --surface: #161b22; --surface2: #21262d;
    --border: #30363d; --text: #e6edf3; --text2: #8b949e;
    --accent: #58a6ff; --green: #3fb950; --red: #f85149;
    --yellow: #d29922; --purple: #bc8cff; --radius: 8px;
    --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    --mono: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
  }
  body { background: var(--bg); color: var(--text); font-family: var(--font); font-size: 14px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
  header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 20px; display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
  header h1 { font-size: 16px; font-weight: 600; color: var(--accent); }
  header .status { margin-left: auto; display: flex; align-items: center; gap: 8px; color: var(--text2); font-size: 12px; }
  .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); }
  .dot.offline { background: var(--red); }
  .main { display: flex; flex: 1; overflow: hidden; }
  /* Sidebar */
  .sidebar { width: 220px; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
  .sidebar-header { padding: 14px 16px 10px; font-size: 11px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.05em; }
  .session-list { flex: 1; overflow-y: auto; padding: 4px 8px; }
  .session-item { padding: 8px 10px; border-radius: var(--radius); cursor: pointer; margin-bottom: 2px; display: flex; align-items: center; gap: 8px; }
  .session-item:hover { background: var(--surface2); }
  .session-item.active { background: var(--surface2); border: 1px solid var(--border); }
  .session-item .avatar { width: 28px; height: 28px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: var(--bg); flex-shrink: 0; }
  .session-item .info { min-width: 0; }
  .session-item .name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 13px; }
  .session-item .model { font-size: 11px; color: var(--text2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  /* Center: Chat */
  .chat-area { flex: 1; display: flex; flex-direction: column; min-width: 0; }
  .chat-toolbar { padding: 10px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; background: var(--surface); flex-shrink: 0; }
  .chat-toolbar .title { font-weight: 600; font-size: 15px; }
  .chat-toolbar .spacer { flex: 1; }
  .btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 5px 12px; border-radius: var(--radius); cursor: pointer; font-size: 12px; font-family: var(--font); }
  .btn:hover { background: var(--border); }
  .btn.primary { background: var(--accent); border-color: var(--accent); color: var(--bg); }
  .btn.primary:hover { opacity: 0.85; }
  .btn.danger { border-color: var(--red); color: var(--red); }
  .btn.danger:hover { background: rgba(248,81,73,0.1); }
  .messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
  .message { display: flex; gap: 10px; max-width: 800px; }
  .message.assistant { align-self: flex-start; }
  .message.user { align-self: flex-end; flex-direction: row-reverse; }
  .message .bubble { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px 14px; max-width: 680px; line-height: 1.6; }
  .message.user .bubble { background: var(--accent); border-color: var(--accent); color: var(--bg); }
  .message .role { font-size: 11px; color: var(--text2); margin-bottom: 4px; font-weight: 600; }
  .message pre { background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 10px; overflow-x: auto; font-family: var(--mono); font-size: 12px; margin: 6px 0; }
  .message code { font-family: var(--mono); font-size: 12px; background: var(--bg); padding: 1px 4px; border-radius: 3px; }
  .tool-event { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 8px 12px; font-size: 12px; color: var(--text2); font-family: var(--mono); align-self: center; max-width: 600px; }
  .tool-event .tool-name { color: var(--yellow); font-weight: 600; }
  .tool-event .tool-ok { color: var(--green); }
  .tool-event .tool-err { color: var(--red); }
  .input-area { padding: 12px 16px; border-top: 1px solid var(--border); background: var(--surface); flex-shrink: 0; }
  .input-row { display: flex; gap: 8px; }
  textarea { flex: 1; background: var(--surface2); border: 1px solid var(--border); color: var(--text); border-radius: var(--radius); padding: 10px 14px; font-family: var(--font); font-size: 14px; resize: none; outline: none; min-height: 44px; max-height: 200px; }
  textarea:focus { border-color: var(--accent); }
  textarea::placeholder { color: var(--text2); }
  .send-btn { background: var(--accent); border: none; color: var(--bg); width: 44px; border-radius: var(--radius); cursor: pointer; font-size: 18px; flex-shrink: 0; }
  .send-btn:hover { opacity: 0.85; }
  .send-btn:disabled { opacity: 0.4; cursor: default; }
  /* Right panel */
  .right-panel { width: 280px; background: var(--surface); border-left: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
  .tabs { display: flex; border-bottom: 1px solid var(--border); }
  .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; font-size: 12px; color: var(--text2); border-bottom: 2px solid transparent; }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-content { flex: 1; overflow-y: auto; display: none; padding: 12px; }
  .tab-content.active { display: block; }
  .file-section { margin-bottom: 16px; }
  .file-label { font-size: 11px; font-weight: 600; color: var(--text2); text-transform: uppercase; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; }
  .file-editor { width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text); border-radius: 4px; padding: 8px; font-family: var(--mono); font-size: 11px; resize: vertical; min-height: 80px; outline: none; }
  .file-editor:focus { border-color: var(--accent); }
  .save-btn { font-size: 10px; padding: 2px 8px; }
  .memory-entry { background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; padding: 8px; margin-bottom: 6px; font-size: 12px; }
  .memory-meta { font-size: 10px; color: var(--text2); margin-top: 4px; }
  .system-info { font-size: 12px; }
  .system-info .row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border); }
  .system-info .val { color: var(--accent); font-family: var(--mono); }
  .empty { color: var(--text2); font-size: 12px; text-align: center; padding: 20px; }
  .typing { display: flex; gap: 4px; align-items: center; padding: 4px 0; }
  .typing span { width: 6px; height: 6px; border-radius: 50%; background: var(--text2); animation: bounce 1.2s infinite; }
  .typing span:nth-child(2) { animation-delay: 0.2s; }
  .typing span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-6px)} }
  ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>
<header>
  <h1>üêæ mini-claw</h1>
  <div class="status">
    <div class="dot" id="ws-dot"></div>
    <span id="ws-status">Connecting...</span>
  </div>
</header>
<div class="main">
  <div class="sidebar">
    <div class="sidebar-header">Sessions</div>
    <div class="session-list" id="session-list"></div>
  </div>
  <div class="chat-area">
    <div class="chat-toolbar">
      <span class="title" id="chat-title">Select a session</span>
      <div class="spacer"></div>
      <button class="btn danger" onclick="clearHistory()" style="display:none" id="clear-btn">Clear</button>
    </div>
    <div class="messages" id="messages">
      <div class="empty">Select a session to start chatting</div>
    </div>
    <div class="input-area">
      <div class="input-row">
        <textarea id="input" placeholder="Message..." rows="1" onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
        <button class="send-btn" id="send-btn" onclick="sendMessage()" disabled>‚û§</button>
      </div>
    </div>
  </div>
  <div class="right-panel">
    <div class="tabs">
      <div class="tab active" onclick="switchTab('files')">Files</div>
      <div class="tab" onclick="switchTab('memory')">Memory</div>
      <div class="tab" onclick="switchTab('system')">System</div>
    </div>
    <div class="tab-content active" id="tab-files">
      <div id="file-editors"></div>
    </div>
    <div class="tab-content" id="tab-memory">
      <div id="memory-list"><div class="empty">Select a session</div></div>
    </div>
    <div class="tab-content" id="tab-system">
      <div id="system-info" class="system-info"></div>
    </div>
  </div>
</div>
<script>
let currentSession = null;
let sessions = [];
let ws = null;
let isThinking = false;

function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}`);
  ws.onopen = () => { setWsStatus(true); };
  ws.onclose = () => { setWsStatus(false); setTimeout(connectWS, 3000); };
  ws.onerror = () => setWsStatus(false);
  ws.onmessage = (e) => {
    const event = JSON.parse(e.data);
    handleEvent(event);
  };
}

function setWsStatus(connected) {
  document.getElementById('ws-dot').className = connected ? 'dot' : 'dot offline';
  document.getElementById('ws-status').textContent = connected ? 'Connected' : 'Disconnected';
}

function handleEvent(event) {
  if (event.sessionId !== currentSession) return;
  if (event.type === 'tool_call') {
    removeTyping();
    const names = event.data.tools.map(t => t.name).join(', ');
    appendToolEvent(`‚öô ${names}`, null);
  } else if (event.type === 'tool_result') {
    const ok = event.data.success;
    appendToolEvent(`${ok ? '‚úì' : '‚úó'} ${event.data.tool}: ${event.data.output.slice(0,100)}`, ok);
  } else if (event.type === 'message' && event.data.role === 'assistant') {
    removeTyping();
    appendMessage('assistant', event.data.content);
    isThinking = false;
    document.getElementById('send-btn').disabled = false;
    document.getElementById('input').disabled = false;
  } else if (event.type === 'heartbeat') {
    appendToolEvent(`üíì Heartbeat: ${event.data.response?.slice(0,100)}`, true);
  }
}

async function loadSessions() {
  const res = await fetch('/api/sessions');
  sessions = await res.json();
  const list = document.getElementById('session-list');
  list.innerHTML = '';
  sessions.forEach(s => {
    const el = document.createElement('div');
    el.className = 'session-item' + (s.id === currentSession ? ' active' : '');
    el.innerHTML = `<div class="avatar">${s.name.charAt(0).toUpperCase()}</div><div class="info"><div class="name">${s.name}</div><div class="model">${s.model}</div></div>`;
    el.onclick = () => selectSession(s.id);
    list.appendChild(el);
  });
}

async function selectSession(id) {
  currentSession = id;
  loadSessions();
  const session = sessions.find(s => s.id === id);
  document.getElementById('chat-title').textContent = session?.name ?? id;
  document.getElementById('clear-btn').style.display = '';
  document.getElementById('send-btn').disabled = false;
  document.getElementById('input').disabled = false;
  await loadHistory();
  await loadFiles();
  await loadMemory();
}

async function loadHistory() {
  const res = await fetch(`/api/sessions/${currentSession}/history`);
  const history = await res.json();
  const container = document.getElementById('messages');
  container.innerHTML = '';
  history.forEach(m => {
    if (m.role === 'user' || m.role === 'assistant') {
      appendMessage(m.role, m.content, false);
    }
  });
  container.scrollTop = container.scrollHeight;
}

function appendMessage(role, content, scroll = true) {
  const container = document.getElementById('messages');
  const emptyEl = container.querySelector('.empty');
  if (emptyEl) emptyEl.remove();
  const div = document.createElement('div');
  div.className = `message ${role}`;
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  if (role === 'assistant') {
    const roleLabel = document.createElement('div');
    roleLabel.className = 'role';
    roleLabel.textContent = 'AI';
    bubble.appendChild(roleLabel);
  }
  const text = document.createElement('div');
  text.innerHTML = formatMarkdown(content || '');
  bubble.appendChild(text);
  div.appendChild(bubble);
  container.appendChild(div);
  if (scroll) container.scrollTop = container.scrollHeight;
}

function appendToolEvent(text, success) {
  const container = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'tool-event';
  div.innerHTML = `<span class="${success === null ? '' : success ? 'tool-ok' : 'tool-err'}">${escapeHtml(text)}</span>`;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function showTyping() {
  const container = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'message assistant';
  div.id = 'typing-indicator';
  div.innerHTML = '<div class="bubble"><div class="typing"><span></span><span></span><span></span></div></div>';
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function removeTyping() {
  document.getElementById('typing-indicator')?.remove();
}

async function sendMessage() {
  if (!currentSession || isThinking) return;
  const input = document.getElementById('input');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  autoResize(input);
  appendMessage('user', msg);
  isThinking = true;
  document.getElementById('send-btn').disabled = true;
  input.disabled = true;
  showTyping();
  try {
    await fetch(`/api/sessions/${currentSession}/message`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: msg }),
    });
  } catch (e) {
    removeTyping();
    appendMessage('assistant', 'Error: ' + e.message);
    isThinking = false;
    document.getElementById('send-btn').disabled = false;
    input.disabled = false;
  }
}

async function clearHistory() {
  if (!currentSession || !confirm('Clear conversation history?')) return;
  await fetch(`/api/sessions/${currentSession}/history`, { method: 'DELETE' });
  document.getElementById('messages').innerHTML = '<div class="empty">History cleared</div>';
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}
function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 200) + 'px'; }

const FILES = ['IDENTITY.md', 'USER.md', 'MEMORY.md', 'HEARTBEAT.md'];
async function loadFiles() {
  const container = document.getElementById('file-editors');
  container.innerHTML = '';
  for (const f of FILES) {
    const res = await fetch(`/api/sessions/${currentSession}/files/${f}`);
    const { content } = await res.json();
    const section = document.createElement('div');
    section.className = 'file-section';
    section.innerHTML = `
      <div class="file-label">${f} <button class="btn save-btn" onclick="saveFile('${f}', this)">Save</button></div>
      <textarea class="file-editor" id="editor-${f}" rows="5">${escapeHtml(content)}</textarea>
    `;
    container.appendChild(section);
  }
}

async function saveFile(filename, btn) {
  const content = document.getElementById(`editor-${filename}`).value;
  await fetch(`/api/sessions/${currentSession}/files/${filename}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ content }),
  });
  btn.textContent = 'Saved!';
  setTimeout(() => btn.textContent = 'Save', 1500);
}

async function loadMemory() {
  const res = await fetch(`/api/sessions/${currentSession}/memory`);
  const entries = await res.json();
  const container = document.getElementById('memory-list');
  if (!entries.length) { container.innerHTML = '<div class="empty">No long-term memories yet</div>'; return; }
  container.innerHTML = entries.slice(0, 50).map(e => `
    <div class="memory-entry">
      <div>${escapeHtml(e.text.slice(0, 200))}</div>
      <div class="memory-meta">${e.metadata.timestamp?.slice(0,10) ?? ''} ${e.metadata.category ? '¬∑ ' + e.metadata.category : ''}</div>
    </div>
  `).join('');
}

function switchTab(name) {
  document.querySelectorAll('.tab').forEach((t, i) => t.className = 'tab' + (['files','memory','system'][i] === name ? ' active' : ''));
  document.querySelectorAll('.tab-content').forEach(c => c.className = 'tab-content');
  document.getElementById(`tab-${name}`).className = 'tab-content active';
  if (name === 'system') loadSystemInfo();
}

async function loadSystemInfo() {
  const res = await fetch('/api/system');
  const info = await res.json();
  const container = document.getElementById('system-info');
  const mb = v => (v / 1024 / 1024).toFixed(1) + ' MB';
  container.innerHTML = `
    <div class="row"><span>Uptime</span><span class="val">${Math.floor(info.uptime)}s</span></div>
    <div class="row"><span>Sessions</span><span class="val">${info.sessions}</span></div>
    <div class="row"><span>Node</span><span class="val">${info.nodeVersion}</span></div>
    <div class="row"><span>Heap Used</span><span class="val">${mb(info.memory.heapUsed)}</span></div>
    <div class="row"><span>RSS</span><span class="val">${mb(info.memory.rss)}</span></div>
    <div class="row"><span>Version</span><span class="val">${info.version}</span></div>
  `;
}

function formatMarkdown(text) {
  return text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/\n/g, '<br>');
}
function escapeHtml(text) {
  return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

connectWS();
loadSessions();
setInterval(() => { if (document.getElementById('tab-system').className.includes('active')) loadSystemInfo(); }, 5000);
</script>
</body>
</html>
